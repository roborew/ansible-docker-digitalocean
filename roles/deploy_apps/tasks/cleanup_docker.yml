---
- name: "Display Docker cleanup warning"
  debug:
    msg: |
      âš ï¸  Docker Cleanup Operation
      ============================
      This will clean up:
      - Unused containers
      - Unused images  
      - Unused networks
      - Unused volumes (with confirmation)
      - Build cache

- name: "Show current Docker usage"
  shell: |
    echo "ğŸ“Š Current Docker Resource Usage:"
    echo "=================================="
    echo ""
    echo "ğŸ–¼ï¸  Images:"
    docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" | head -10
    echo ""
    echo "ğŸ“¦ Containers:"
    docker ps -a --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
    echo ""
    echo "ğŸŒ Networks:"
    docker network ls
    echo ""
    echo "ğŸ’¾ Volumes:"
    docker volume ls
    echo ""
    echo "ğŸ’¿ Disk Usage:"
    docker system df
  register: current_usage
  changed_when: false

- name: "Display current usage"
  debug:
    msg: "{{ current_usage.stdout }}"

- name: "Clean up stopped containers"
  shell: |
    echo "ğŸ—‘ï¸  Cleaning up stopped containers..."
    docker container prune -f
    echo "Containers cleaned up"
  register: container_cleanup

- name: "Clean up unused images"
  shell: |
    echo "ğŸ—‘ï¸  Cleaning up unused images..."
    docker image prune -f
    echo "Images cleaned up"
  register: image_cleanup

- name: "Clean up unused networks"
  shell: |
    echo "ğŸ—‘ï¸  Cleaning up unused networks..."
    docker network prune -f
    echo "Networks cleaned up"
  register: network_cleanup

- name: "Clean up build cache"
  shell: |
    echo "ğŸ—‘ï¸  Cleaning up build cache..."
    docker builder prune -f
    echo "Build cache cleaned up"
  register: buildcache_cleanup
  ignore_errors: true

- name: "Show cleanup results"
  shell: |
    echo "âœ… Docker Cleanup Complete!"
    echo "=========================="
    echo ""
    echo "ğŸ“Š New Docker Resource Usage:"
    docker system df
    echo ""
    echo "ğŸ“ˆ Space Freed:"
    echo "- Containers: cleaned"
    echo "- Images: cleaned"  
    echo "- Networks: cleaned"
    echo "- Build cache: cleaned"
  register: cleanup_results
  changed_when: false

- name: "Display cleanup summary"
  debug:
    msg: |
      ğŸ‰ Docker cleanup complete!

      {{ cleanup_results.stdout }}

      Cleanup Details:
      - {{ container_cleanup.stdout }}
      - {{ image_cleanup.stdout }}
      - {{ network_cleanup.stdout }}
      - {{ buildcache_cleanup.stdout | default('Build cache cleanup skipped') }}

      Note: Volumes were not cleaned automatically for safety.
      To clean volumes manually: docker volume prune
